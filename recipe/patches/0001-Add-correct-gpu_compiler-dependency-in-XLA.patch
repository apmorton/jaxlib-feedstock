From 1c4715a8e0570ef5d5108b7b37e496ed904afd51 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Tue, 17 Oct 2023 17:15:54 +0200
Subject: [PATCH] Add correct gpu_compiler dependency in XLA

---
 ...-dependency-inside-if_cuda_or_rocm-b.patch | 41 +++++++++++++++++++
 ...cuda_build_defs-in-NCCL-system-build.patch | 40 ++++++++++++++++++
 third_party/xla/workspace.bzl                 |  5 +++
 3 files changed, 86 insertions(+)
 create mode 100644 third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch
 create mode 100644 third_party/xla/0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch

diff --git a/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch b/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch
new file mode 100644
index 0000000..1f03117
--- /dev/null
+++ b/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch
@@ -0,0 +1,41 @@
+From cf5c4a2fc08f3f1c2e554b19abfe804600a992fa Mon Sep 17 00:00:00 2001
+From: Adrian Kuegel <akuegel@google.com>
+Date: Mon, 9 Oct 2023 05:33:53 -0700
+Subject: [PATCH 1/2] Add gpu_compiler dependency inside if_cuda_or_rocm block.
+
+This avoids a duplicate dependency problem if both if_cuda and if_rocm blocks
+are taken.
+
+PiperOrigin-RevId: 571911265
+---
+ xla/pjrt/gpu/BUILD | 6 +++---
+ 1 file changed, 3 insertions(+), 3 deletions(-)
+
+diff --git a/xla/pjrt/gpu/BUILD b/xla/pjrt/gpu/BUILD
+index fd18d73bf..4219aff4a 100644
+--- a/xla/pjrt/gpu/BUILD
++++ b/xla/pjrt/gpu/BUILD
+@@ -238,17 +238,17 @@ cc_library(
+         "@com_google_absl//absl/status",
+         "@tsl//tsl/platform:casts",
+         "@tsl//tsl/platform:errors",
+-    ] + if_cuda([
++    ] + if_cuda_or_rocm([
++        "//xla/service/gpu:gpu_compiler",
++    ]) + if_cuda([
+         ":nccl_id_store_cuda",
+         "@local_config_cuda//cuda:cuda_headers",
+         "//xla/stream_executor/cuda:cuda_activation_header",
+         "//xla/stream_executor/gpu:gpu_cudamallocasync_allocator",
+-        "//xla/service/gpu:gpu_compiler",
+         "//xla/service/gpu:nvptx_compiler_impl",
+     ]) + if_rocm([
+         ":nccl_id_store_rocm",
+         "@local_config_rocm//rocm:rocm_headers",
+-        "//xla/service/gpu:gpu_compiler",
+         "//xla/service/gpu:amdgpu_compiler_impl",
+     ]),
+     alwayslink = True,
+-- 
+2.42.0
+
diff --git a/third_party/xla/0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch b/third_party/xla/0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch
new file mode 100644
index 0000000..0f1fc06
--- /dev/null
+++ b/third_party/xla/0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch
@@ -0,0 +1,40 @@
+From b8c8f18d3ad72d5a6a89f12fdaba0b97ccb32fe4 Mon Sep 17 00:00:00 2001
+From: Peter Hawkins <phawkins@google.com>
+Date: Fri, 13 Oct 2023 10:37:55 -0700
+Subject: [PATCH 2/2] Fix path to cuda_build_defs in NCCL system build.
+
+Copy of https://github.com/openxla/xla/pull/6291 that resolves a TSL merge problem.
+
+PiperOrigin-RevId: 573259068
+---
+ third_party/nccl/system.BUILD.tpl                 | 2 +-
+ third_party/tsl/third_party/nccl/system.BUILD.tpl | 2 +-
+ 2 files changed, 2 insertions(+), 2 deletions(-)
+
+diff --git a/third_party/nccl/system.BUILD.tpl b/third_party/nccl/system.BUILD.tpl
+index 2868efb3e..98d0e080d 100644
+--- a/third_party/nccl/system.BUILD.tpl
++++ b/third_party/nccl/system.BUILD.tpl
+@@ -1,6 +1,6 @@
+ load("@bazel_skylib//rules:write_file.bzl", "write_file")
+ load(
+-    "@xla//tensorflow/platform/default:cuda_build_defs.bzl",
++    "@tsl//tsl/platform/default:cuda_build_defs.bzl",
+     "cuda_rpath_flags"
+ )
+ 
+diff --git a/third_party/tsl/third_party/nccl/system.BUILD.tpl b/third_party/tsl/third_party/nccl/system.BUILD.tpl
+index 997b7b9fd..98d0e080d 100644
+--- a/third_party/tsl/third_party/nccl/system.BUILD.tpl
++++ b/third_party/tsl/third_party/nccl/system.BUILD.tpl
+@@ -1,6 +1,6 @@
+ load("@bazel_skylib//rules:write_file.bzl", "write_file")
+ load(
+-    "@tsl//tensorflow/platform/default:cuda_build_defs.bzl",
++    "@tsl//tsl/platform/default:cuda_build_defs.bzl",
+     "cuda_rpath_flags"
+ )
+ 
+-- 
+2.42.0
+
diff --git a/third_party/xla/workspace.bzl b/third_party/xla/workspace.bzl
index b399df3..b7d7403 100644
--- a/third_party/xla/workspace.bzl
+++ b/third_party/xla/workspace.bzl
@@ -29,6 +29,11 @@ def repo():
         sha256 = XLA_SHA256,
         strip_prefix = "xla-{commit}".format(commit = XLA_COMMIT),
         urls = tf_mirror_urls("https://github.com/openxla/xla/archive/{commit}.tar.gz".format(commit = XLA_COMMIT)),
+        # Patches applied upstream on top of https://github.com/xhochy/xla/tree/jaxlib-0.4.18-patches
+        patch_file = [
+            "//third_party/xla:0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch",
+            "//third_party/xla:0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch",
+        ],
     )
 
     # For development, one often wants to make changes to the TF repository as well
-- 
2.39.3 (Apple Git-145)

