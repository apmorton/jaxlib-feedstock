From ca6963931187f9b3e55686d9f981661d409a4bde Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Tue, 17 Oct 2023 17:15:54 +0200
Subject: [PATCH] Add correct gpu_compiler dependency in XLA

---
 ...-dependency-inside-if_cuda_or_rocm-b.patch | 41 +++++++++++++++++++
 third_party/xla/workspace.bzl                 |  5 +++
 2 files changed, 46 insertions(+)
 create mode 100644 third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch

diff --git a/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch b/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch
new file mode 100644
index 0000000..1f03117
--- /dev/null
+++ b/third_party/xla/0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch
@@ -0,0 +1,41 @@
+From cf5c4a2fc08f3f1c2e554b19abfe804600a992fa Mon Sep 17 00:00:00 2001
+From: Adrian Kuegel <akuegel@google.com>
+Date: Mon, 9 Oct 2023 05:33:53 -0700
+Subject: [PATCH 1/2] Add gpu_compiler dependency inside if_cuda_or_rocm block.
+
+This avoids a duplicate dependency problem if both if_cuda and if_rocm blocks
+are taken.
+
+PiperOrigin-RevId: 571911265
+---
+ xla/pjrt/gpu/BUILD | 6 +++---
+ 1 file changed, 3 insertions(+), 3 deletions(-)
+
+diff --git a/xla/pjrt/gpu/BUILD b/xla/pjrt/gpu/BUILD
+index fd18d73bf..4219aff4a 100644
+--- a/xla/pjrt/gpu/BUILD
++++ b/xla/pjrt/gpu/BUILD
+@@ -238,17 +238,17 @@ cc_library(
+         "@com_google_absl//absl/status",
+         "@tsl//tsl/platform:casts",
+         "@tsl//tsl/platform:errors",
+-    ] + if_cuda([
++    ] + if_cuda_or_rocm([
++        "//xla/service/gpu:gpu_compiler",
++    ]) + if_cuda([
+         ":nccl_id_store_cuda",
+         "@local_config_cuda//cuda:cuda_headers",
+         "//xla/stream_executor/cuda:cuda_activation_header",
+         "//xla/stream_executor/gpu:gpu_cudamallocasync_allocator",
+-        "//xla/service/gpu:gpu_compiler",
+         "//xla/service/gpu:nvptx_compiler_impl",
+     ]) + if_rocm([
+         ":nccl_id_store_rocm",
+         "@local_config_rocm//rocm:rocm_headers",
+-        "//xla/service/gpu:gpu_compiler",
+         "//xla/service/gpu:amdgpu_compiler_impl",
+     ]),
+     alwayslink = True,
+-- 
+2.42.0
+
diff --git a/third_party/xla/workspace.bzl b/third_party/xla/workspace.bzl
index b399df3..b7d7403 100644
--- a/third_party/xla/workspace.bzl
+++ b/third_party/xla/workspace.bzl
@@ -29,6 +29,11 @@ def repo():
         sha256 = XLA_SHA256,
         strip_prefix = "xla-{commit}".format(commit = XLA_COMMIT),
         urls = tf_mirror_urls("https://github.com/openxla/xla/archive/{commit}.tar.gz".format(commit = XLA_COMMIT)),
+        # Patches applied upstream on top of https://github.com/xhochy/xla/tree/jaxlib-0.4.18-patches
+        patch_file = [
+            "//third_party/xla:0001-Add-gpu_compiler-dependency-inside-if_cuda_or_rocm-b.patch",
+            "//third_party/xla:0002-Fix-path-to-cuda_build_defs-in-NCCL-system-build.patch",
+        ],
     )
 
     # For development, one often wants to make changes to the TF repository as well
-- 
2.39.3 (Apple Git-145)

